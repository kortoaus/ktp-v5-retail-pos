# 환불 규칙

POS에서 완료된 판매 건에 대해 환불을 처리하는 방법.

---

## 개요

환불은 `type: "refund"`인 새 영수증을 생성하며, `original_invoice_id`를 통해 원래 판매 건에 연결됩니다. 전체 또는 부분 환불이 가능합니다 — 품목별, 수량별. 환불 금액은 선택한 품목에서 자동 계산되며, 수동 입력이 아닙니다.

---

## 환불 흐름

### 1. 원래 영수증 찾기

매니저가 영수증 검색 화면에서 판매 영수증을 검색합니다. 키워드 (영수증 번호, 상품명, 바코드), 날짜 범위, 회원 필터를 지원합니다. 바코드 스캔 시 영수증 번호를 자동 검색합니다.

### 2. 환불할 품목 선택

원래 영수증의 품목이 왼쪽 패널에 표시됩니다. 각 품목은 남은 환불 가능 수량 (원래 수량 - 이전 환불에서 이미 환불된 수량)을 보여줍니다.

품목을 클릭하면 환불 목록 (오른쪽 패널)에 추가됩니다:

| 품목 유형 | 동작 |
|-----------|------|
| 계량팩 | 전부 또는 전무 — 전체 수량으로 추가 (계량 품목은 분할 불가) |
| 수량 = 1 | 바로 추가 — 수량 입력 불필요 |
| 남은 수량 = 1 | 바로 추가 — 1개만 남아 선택지 없음 |
| 수량 > 1, 남은 수량 > 1 | 수량 입력 모달 열림 — 환불할 수량 입력 |

이미 전량 환불된 품목 (남은 수량 = 0)은 알림과 함께 차단됩니다.

현재 환불 목록에 이미 있는 품목도 차단됩니다 — 수량을 변경하려면 먼저 제거하세요.

### 3. 환불 금액

부분 수량 환불의 경우, 원래 판매 라인에서 비례 계산됩니다:

```
effectiveUnitPrice = originalTotal ÷ originalQty
refundTotal        = effectiveUnitPrice × refundQty
refundTax          = originalTax × (refundQty ÷ originalQty)
```

남은 수량 전체를 환불하는 경우, 비례 계산 대신 정확한 남은 값을 사용합니다 (여러 번의 부분 환불로 인한 누적 반올림 오차 방지).

### 4. 검토

세 번째 패널에 실시간 요약이 표시됩니다:
- 선택된 품목 수
- 총 수량
- 환불 소계
- GST 포함
- **환불 금액** (돌려줄 금액)

### 5. 환불 처리 (결제)

"Process Refund" 버튼을 누르면 결제 모달이 열립니다. 환불 금액은 원래 판매의 결제 수단을 고려하여 현금과 카드로 분배해야 합니다.

---

## 결제 규칙

### 결제 수단 한도

각 결제 수단은 원래 판매에서 해당 수단의 남은 환불 가능 금액으로 제한되며, 이전 환불을 고려합니다:

```
remainingCashCap   = originalCashPaid − Σ previousRefundsCash
remainingCreditCap = originalCreditPaid − Σ previousRefundsCredit
```

서버는 환불 가능 영수증 데이터와 함께 `remainingCash`와 `remainingCredit`을 제공합니다.

**예시:** 원래 판매가 현금 $30 + 카드 $20으로 결제됨. 첫 번째 환불에서 현금 $10 반환. 다음 환불 시: 현금 한도 = $20, 카드 한도 = $20.

### 반올림

5센트 반올림 규칙이 환불 총액에 항상 적용됩니다 (판매와 동일). 결제 수단에 관계없이 환불 금액은 항상 5센트 단위로 반올림됩니다.

### 수수료 없음

카드 환불에는 수수료가 **부과되지 않습니다.** 원래 판매의 수수료는 환불되지 않습니다.

### 잔액 일치

현금 환불 + 카드 환불은 (반올림된) 환불 총액과 정확히 일치해야 합니다. 잔액이 맞을 때까지 확인 버튼은 비활성화됩니다.

현금 또는 카드 입력을 더블 탭하면 남은 잔액이 자동 입력됩니다.

---

## 서버 검증

서버는 데이터베이스 트랜잭션 내에서 모든 환불을 검증하여 경합 조건을 방지합니다 (예: 두 터미널이 동시에 같은 품목을 환불하는 경우):

1. **행 검증** — 각 환불 행의 `original_invoice_row_id`가 원래 영수증에 존재해야 하며, 수량이 남은 수량을 초과할 수 없음
2. **결제 검증** — 현금 환불 ≤ 남은 현금 한도, 카드 환불 ≤ 남은 카드 한도
3. **영수증 생성** — `type: "refund"`, `original_invoice_id`와 `original_invoice_serialNumber`를 통해 원래 건에 연결
4. **시프트 업데이트** — 터미널 시프트의 `refundsCash`와 `refundsCredit` 증가 (정산에 사용)

---

## 영수증

확인 후 환불 영수증이 자동으로 출력됩니다. 판매 영수증과는 별도의 템플릿을 사용합니다.

환불 영수증 구성:
1. **매장 헤더** — 판매 영수증과 동일
2. **\*\*\* REFUND \*\*\*** 배너
3. **거래 정보** — 환불 영수증 번호, 원래 영수증 번호, 날짜/시간, 터미널
4. **환불 품목** — 각 품목의 수량과 합계
5. **합계** — 품목 수, 반올림 (있는 경우), **환불 총액**
6. **결제 내역** — 현금 환불, 카드 환불
7. **하단** — GST 포함, "Refund processed"
8. **QR 코드** — 환불 영수증 번호
9. **출력 시각**

### 재출력

환불이 있는 판매 영수증을 재출력하면, 판매 영수증에 이어 연결된 모든 환불 영수증이 **하나의 연속 용지**로 출력되며 마지막에 한 번만 절단됩니다. 단독 환불 재출력은 개별 출력됩니다.

---

## 캐시 드로어

현금이 환불될 때 (`cashPaid > 0`) 캐시 드로어가 자동으로 열립니다.

---

## 완료 후

환불이 성공적으로 완료되면 시스템이 홈 화면으로 이동합니다. 환불 화면 상태는 초기화됩니다.

---

## 정산 영향

환불은 터미널 시프트에 별도로 추적됩니다:

```
endedCashExpected = startedCash + salesCash − refundsCash
```

`refundsCash`와 `refundsCredit`은 모두 센트 단위로 `TerminalShift`에 저장되며, 각 환불 영수증 생성 시 원자적으로 업데이트됩니다.

---

## 제한 사항

- `type: "sale"` 영수증만 환불 가능 (다른 환불 건은 불가)
- 환불 화면 접근에 매니저 인증 필요
- 환불 행은 항상 원래 행에 연결됨 (`original_invoice_row_id`)
- 원래 수량을 초과하여 환불할 수 없음
- 결제 한도는 원래 결제 수단별 금액을 초과할 수 없음
